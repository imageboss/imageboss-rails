# Run tests locally with different Ruby versions.
# Set RAILS_VERSION to match the Rails version you want to test (same as CI matrix).
#
# Examples:
#   RAILS_VERSION=6.1.7.8 docker compose run ruby33
#   RAILS_VERSION=8.0.2   docker compose run ruby33
#   RAILS_VERSION=5.2.8.1 docker compose run ruby27
#
# Build first: docker compose build

services:
  ruby27:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        RUBY_VERSION: "2.7"
    image: imageboss-rails-ruby27
    volumes:
      - .:/app
    working_dir: /app
    environment:
      RAILS_VERSION: ${RAILS_VERSION:-6.1.7.8}

  ruby33:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        RUBY_VERSION: "3.3"
    image: imageboss-rails-ruby33
    volumes:
      - .:/app
    working_dir: /app
    environment:
      RAILS_VERSION: ${RAILS_VERSION:-6.1.7.8}

  # Release: build gem, tag, push to git and RubyGems. Use after bumping version and updating CHANGELOG.
  # Requires GEM_HOST_API_KEY and git push access (e.g. mount SSH). See RELEASING.md.
  release:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        RUBY_VERSION: "3.3"
    image: imageboss-rails-ruby33
    volumes:
      - .:/app
      # Mount SSH so git push works (optional if you use HTTPS with token)
      - ${HOME}/.ssh:/root/.ssh:ro
    working_dir: /app
    environment:
      # Use Rails 8 so Gemfile gets sqlite3 >= 2.1 (compiles on Ruby 3.3). Published gem still has rails ">= 5.0.2" from gemspec.
      RAILS_VERSION: "8.0.2"
      GEM_HOST_API_KEY: ${GEM_HOST_API_KEY}
    # Unset RAILS_VERSION for rake release so the built gem has rails ">= 5.0.2" in the gemspec, not ~> 8.0.2.
    command: ["sh", "-c", "bundle install && RAILS_VERSION= bundle exec rake release"]
